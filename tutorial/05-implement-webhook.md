---
ms.openlocfilehash: f55eecd4d157c945d0e95870d4e481653b26c9ec
ms.sourcegitcommit: 57a5c2e1a562d8af092a3e78786d711ce1e8f9cb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/30/2020
ms.locfileid: "48822530"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="c31ca-101">Neste exercício, você concluirá a implementação das funções do Azure `SetSubscription` e `Notify` atualizará o aplicativo de teste para inscrever-se e cancelar a assinatura das alterações na caixa de entrada de um usuário.</span><span class="sxs-lookup"><span data-stu-id="c31ca-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="c31ca-102">A `SetSubscription` função atuará como uma API, permitindo que o aplicativo de teste crie ou exclua uma [assinatura](https://docs.microsoft.com/graph/webhooks) para alterações na caixa de entrada de um usuário.</span><span class="sxs-lookup"><span data-stu-id="c31ca-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="c31ca-103">A `Notify` função atuará como o webhook que recebe notificações de alteração geradas pela assinatura.</span><span class="sxs-lookup"><span data-stu-id="c31ca-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="c31ca-104">Ambas as funções usarão o [fluxo de concessão de credenciais do cliente](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) para obter um token somente de aplicativo para chamar o Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c31ca-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="c31ca-105">Como um administrador concedeu consentimento de administrador aos escopos de permissão necessários, nenhuma interação do usuário será necessária para obter o token.</span><span class="sxs-lookup"><span data-stu-id="c31ca-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="c31ca-106">Adicionar autenticação de credenciais de cliente ao projeto de funções do Azure</span><span class="sxs-lookup"><span data-stu-id="c31ca-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="c31ca-107">Nesta seção, você implementará o fluxo de credenciais do cliente no projeto de funções do Azure para obter um token de acesso compatível com o Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c31ca-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="c31ca-108">Abra a CLI no diretório que contém **GraphTutorial. csproj**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="c31ca-109">Adicione a ID e o segredo do aplicativo webhook ao repositório secreto usando os seguintes comandos.</span><span class="sxs-lookup"><span data-stu-id="c31ca-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="c31ca-110">Substitua `YOUR_WEBHOOK_APP_ID_HERE` pela ID do aplicativo do **webhook da função Graph Azure**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="c31ca-111">Substitua `YOUR_WEBHOOK_APP_SECRET_HERE` pelo segredo do aplicativo que você criou no portal do Azure para o **webhook de função do Azure Graph**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="c31ca-112">Criar um provedor de autenticação de credenciais de cliente</span><span class="sxs-lookup"><span data-stu-id="c31ca-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="c31ca-113">Crie um novo arquivo no diretório **./GraphTutorial/Authentication** chamado **ClientCredentialsAuthProvider.cs** e adicione o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="c31ca-114">Reserve um tempo para considerar o que o código no **ClientCredentialsAuthProvider.cs** faz.</span><span class="sxs-lookup"><span data-stu-id="c31ca-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="c31ca-115">No construtor, ele inicializa um **ConfidentialClientApplication** do `Microsoft.Identity.Client` pacote.</span><span class="sxs-lookup"><span data-stu-id="c31ca-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="c31ca-116">Ele usa as `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` `.WithTenantId(tenantId)` funções e para restringir a audiência de login apenas à organização especificada do Microsoft 365.</span><span class="sxs-lookup"><span data-stu-id="c31ca-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="c31ca-117">Na `GetAccessToken` função, ele chama `AcquireTokenForClient` para obter um token para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="c31ca-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="c31ca-118">O fluxo de token de credenciais do cliente é sempre não interativo.</span><span class="sxs-lookup"><span data-stu-id="c31ca-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="c31ca-119">Ele implementa a `Microsoft.Graph.IAuthenticationProvider` interface, permitindo que essa classe seja passada no construtor do `GraphServiceClient` para autenticar solicitações de saída.</span><span class="sxs-lookup"><span data-stu-id="c31ca-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="c31ca-120">Atualizar GraphClientService</span><span class="sxs-lookup"><span data-stu-id="c31ca-120">Update GraphClientService</span></span>

1. <span data-ttu-id="c31ca-121">Abra **GraphClientService.cs** e adicione a propriedade a seguir à classe.</span><span class="sxs-lookup"><span data-stu-id="c31ca-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="c31ca-122">Substitua a função `GetAppGraphClient` existente pelo seguinte.</span><span class="sxs-lookup"><span data-stu-id="c31ca-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

## <a name="implement-notify-function"></a><span data-ttu-id="c31ca-123">Implementar função Notify</span><span class="sxs-lookup"><span data-stu-id="c31ca-123">Implement Notify function</span></span>

<span data-ttu-id="c31ca-124">Nesta seção, você implementará a `Notify` função, que será usada como a URL de notificação para notificações de alteração.</span><span class="sxs-lookup"><span data-stu-id="c31ca-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="c31ca-125">Crie um novo diretório no diretório **GraphTutorials** chamado **modelos**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="c31ca-126">Crie um novo arquivo no diretório **modelos** chamado **ResourceData.cs** e adicione o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="c31ca-127">Crie um novo arquivo no diretório **modelos** chamado **ChangeNotification.cs** e adicione o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-127">Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="c31ca-128">Crie um novo arquivo no diretório **modelos** chamado **NotificationList.cs** e adicione o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="c31ca-129">Abra **./GraphTutorial/Notify.cs** e substitua todo o conteúdo pelo seguinte.</span><span class="sxs-lookup"><span data-stu-id="c31ca-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="c31ca-130">Reserve um tempo para considerar o que o código no **Notify.cs** faz.</span><span class="sxs-lookup"><span data-stu-id="c31ca-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="c31ca-131">A `Run` função verifica a presença de um `validationToken` parâmetro de consulta.</span><span class="sxs-lookup"><span data-stu-id="c31ca-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="c31ca-132">Se esse parâmetro estiver presente, ele processará a solicitação como uma [solicitação de validação](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)e responderá de acordo.</span><span class="sxs-lookup"><span data-stu-id="c31ca-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="c31ca-133">Se a solicitação não for uma solicitação de validação, a carga JSON será desserializada em um `NotificationList` .</span><span class="sxs-lookup"><span data-stu-id="c31ca-133">If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.</span></span>
- <span data-ttu-id="c31ca-134">Cada notificação na lista é verificada quanto ao valor de estado do cliente esperado e é processada.</span><span class="sxs-lookup"><span data-stu-id="c31ca-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="c31ca-135">A mensagem que disparou a notificação é recuperada com o Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c31ca-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="c31ca-136">Implementar função setsubscription</span><span class="sxs-lookup"><span data-stu-id="c31ca-136">Implement SetSubscription function</span></span>

<span data-ttu-id="c31ca-137">Nesta seção, você implementará a função setsubscription.</span><span class="sxs-lookup"><span data-stu-id="c31ca-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="c31ca-138">Essa função atuará como uma API que é chamada pelo aplicativo de teste para criar ou excluir uma assinatura na caixa de entrada de um usuário.</span><span class="sxs-lookup"><span data-stu-id="c31ca-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="c31ca-139">Crie um novo arquivo no diretório **modelos** chamado **SetSubscriptionPayload.cs** e adicione o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="c31ca-140">Abra **./GraphTutorial/SetSubscription.cs** e substitua todo o conteúdo pelo seguinte.</span><span class="sxs-lookup"><span data-stu-id="c31ca-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="c31ca-141">Reserve um tempo para considerar o que o código no **SetSubscription.cs** faz.</span><span class="sxs-lookup"><span data-stu-id="c31ca-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="c31ca-142">A `Run` função lê a carga JSON enviada na solicitação post para determinar o tipo de solicitação (inscrever-se ou cancelar inscrição), a ID de usuário a ser inscrita e a ID da assinatura para cancelar a assinatura.</span><span class="sxs-lookup"><span data-stu-id="c31ca-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="c31ca-143">Se a solicitação for uma solicitação de assinatura, ela usará o SDK do Microsoft Graph para criar uma nova assinatura na caixa de entrada do usuário especificado.</span><span class="sxs-lookup"><span data-stu-id="c31ca-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="c31ca-144">A assinatura notificará quando as mensagens forem criadas ou atualizadas.</span><span class="sxs-lookup"><span data-stu-id="c31ca-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="c31ca-145">A nova assinatura é retornada na carga JSON da resposta.</span><span class="sxs-lookup"><span data-stu-id="c31ca-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="c31ca-146">Se a solicitação for uma solicitação de cancelamento de assinatura, ela usará o SDK do Microsoft Graph para excluir a assinatura especificada.</span><span class="sxs-lookup"><span data-stu-id="c31ca-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="c31ca-147">Chamar setsubscription do aplicativo de teste</span><span class="sxs-lookup"><span data-stu-id="c31ca-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="c31ca-148">Nesta seção, você implementará as funções para criar e excluir assinaturas no aplicativo de teste.</span><span class="sxs-lookup"><span data-stu-id="c31ca-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="c31ca-149">Abra **./TestClient/azurefunctions.js** e adicione a função a seguir.</span><span class="sxs-lookup"><span data-stu-id="c31ca-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="c31ca-150">Este código chama a `SetSubscription` função do Azure para inscrever e adiciona a nova assinatura à matriz de assinaturas na sessão.</span><span class="sxs-lookup"><span data-stu-id="c31ca-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="c31ca-151">Adicione a função a seguir para **azurefunctions.js**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="c31ca-152">Este código chama a `SetSubscription` função do Azure para desmarcar e remover a assinatura da matriz de assinaturas na sessão.</span><span class="sxs-lookup"><span data-stu-id="c31ca-152">This code calls the `SetSubscription` Azure Function to un and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="c31ca-153">Se você não tiver o ngrok em execução, execute ngrok ( `ngrok http 7071` ) e copie a URL de encaminhamento HTTPS.</span><span class="sxs-lookup"><span data-stu-id="c31ca-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="c31ca-154">Adicione a URL do ngrok ao repositório de segredos do usuário executando o seguinte comando.</span><span class="sxs-lookup"><span data-stu-id="c31ca-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="c31ca-155">Se você reiniciar o ngrok, será necessário repetir este comando para atualizar a URL do ngrok.</span><span class="sxs-lookup"><span data-stu-id="c31ca-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="c31ca-156">Altere o diretório atual em sua CLI para o diretório **./GraphTutorial** e execute o seguinte comando para iniciar a função do Azure localmente.</span><span class="sxs-lookup"><span data-stu-id="c31ca-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="c31ca-157">Atualize o SPA e selecione o item de navegação de **assinaturas** .</span><span class="sxs-lookup"><span data-stu-id="c31ca-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="c31ca-158">Insira uma ID de usuário para um usuário em sua organização do Microsoft 365 que tenha uma caixa de correio do Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="c31ca-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="c31ca-159">Isso pode ser o do usuário `id` (do Microsoft Graph) ou o do usuário `userPrincipalName` .</span><span class="sxs-lookup"><span data-stu-id="c31ca-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="c31ca-160">Clique em **inscrever**.</span><span class="sxs-lookup"><span data-stu-id="c31ca-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="c31ca-161">A página é atualizada mostrando a nova assinatura na tabela.</span><span class="sxs-lookup"><span data-stu-id="c31ca-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="c31ca-162">Envie um email para o usuário.</span><span class="sxs-lookup"><span data-stu-id="c31ca-162">Send an email to the user.</span></span> <span data-ttu-id="c31ca-163">Após um breve período, a `Notify` função deve ser chamada.</span><span class="sxs-lookup"><span data-stu-id="c31ca-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="c31ca-164">Você pode verificar isso na interface Web do ngrok ( `http://localhost:4040` ) ou na saída de depuração do projeto de função do Azure.</span><span class="sxs-lookup"><span data-stu-id="c31ca-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="c31ca-165">No aplicativo de teste, clique em **excluir** na linha da tabela da assinatura.</span><span class="sxs-lookup"><span data-stu-id="c31ca-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="c31ca-166">A página é atualizada e a assinatura não está mais na tabela.</span><span class="sxs-lookup"><span data-stu-id="c31ca-166">The page refreshes and the subscription is no longer in the table.</span></span>
